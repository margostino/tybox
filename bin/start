#!/bin/bash

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get service arguments or use all services if none provided
SERVICES="$@"
if [ -z "$SERVICES" ]; then
  echo -e "${GREEN}Starting all Tybox services...${NC}"
  docker-compose up -d
  SERVICES="postgres redis wiremock"
else
  echo -e "${GREEN}Starting specified services: $SERVICES${NC}"
  docker-compose up -d $SERVICES
fi

# Wait for services to be healthy
echo -e "${YELLOW}Waiting for services to be ready...${NC}"

# Function to check if a service should be waited for
should_wait_for() {
  local service=$1
  # If no specific services were requested, wait for all
  if [ "$#" -eq 1 ] && [ -z "$*" ]; then
    return 0
  fi
  # Check if this service is in the list of requested services
  echo "$SERVICES" | grep -q "$service"
}

# Wait for PostgreSQL if it was started
if should_wait_for "postgres"; then
  if docker ps --format "table {{.Names}}" | grep -q tybox-postgres; then
    until docker exec tybox-postgres pg_isready -U postgres > /dev/null 2>&1; do
      echo "Waiting for PostgreSQL..."
      sleep 2
    done
    echo -e "${GREEN}✓ PostgreSQL is ready${NC}"
  fi
fi

# Wait for Redis if it was started
if should_wait_for "redis"; then
  if docker ps --format "table {{.Names}}" | grep -q tybox-redis; then
    until docker exec tybox-redis redis-cli ping > /dev/null 2>&1; do
      echo "Waiting for Redis..."
      sleep 2
    done
    echo -e "${GREEN}✓ Redis is ready${NC}"
  fi
fi

# Wait for WireMock if it was started
if should_wait_for "wiremock"; then
  if docker ps --format "table {{.Names}}" | grep -q tybox-wiremock; then
    until curl -s http://localhost:8080/__admin/health > /dev/null 2>&1; do
      echo "Waiting for WireMock..."
      sleep 2
    done
    echo -e "${GREEN}✓ WireMock is ready${NC}"
  fi
fi

echo -e "${GREEN}Requested services are up and running!${NC}"
echo ""
echo -e "${BLUE}Service URLs:${NC}"

# Show URLs only for started services
if docker ps --format "table {{.Names}}" | grep -q tybox-postgres; then
  echo "  PostgreSQL: localhost:5432 (user: postgres, password: postgres, db: tybox)"
fi
if docker ps --format "table {{.Names}}" | grep -q tybox-redis; then
  echo "  Redis:      localhost:6379"
fi
if docker ps --format "table {{.Names}}" | grep -q tybox-wiremock; then
  echo "  WireMock:   http://localhost:8080/__admin"
fi